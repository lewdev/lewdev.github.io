var e=["verse","group","search"],h=e.indexOf("verse"),l=e.indexOf("group"),m=e.indexOf("search"),n=document.getElementById("verseDisplay"),p=document.getElementById("partSelect"),q=document.getElementById("verseSelect"),r=document.getElementById("verseGroupSelect"),t=document.getElementById("verseNavTop"),u=document.getElementById("verseNavBottom"),v=t.cloneNode(!0),w=document.querySelector(".verse-options"),x=document.getElementById("searchTxt"),y=document.getElementById("searchBtn"),z=document.getElementById("searchResults"),
A=document.getElementById("groupView"),B={view:0,selectedPart:1,selectedVerse:1,selectedVerseGroup:"1:1-20",searchStr:"",verseOptions:{showRomanized:!0,showJapanese:!0,showEnglish:!0,showKanji:!0,showEnglish2:!1},groupOptions:{showRomanized:!0,showJapanese:!0,showEnglish:!1,showKanji:!1,showEnglish2:!1},searchOptions:{showRomanized:!0,showJapanese:!0,showEnglish:!0,showKanji:!0,showEnglish2:!1},isDataLoaded:!1},C=null,D=null;
function E(){p.onchange=function(){F(parseInt(p.value,10))};q.onchange=function(){G(parseInt(q.value,10))};r.onchange=function(){H(r.value)};H(B.selectedVerseGroup);F(B.selectedPart);G(B.selectedVerse);I(B.view);x.onkeyup=function(a){13===a.keyCode&&J()};x.value=B.searchStr;y.onclick=function(){J()}}function J(){B.searchStr=x.value.trim();K()}function L(){B.view===h?M():B.view===l?N():B.view===m&&K()}function F(a){B.selectedPart=a;p.value=B.selectedPart;B.selectedVerse=1;O(a);M()}
function G(a){B.selectedVerse=a;q.value=B.selectedVerse;M()}function H(a){B.selectedVerseGroup=a;r.value=B.selectedVerseGroup;N()}function P(a){var b=C.verses.length;return 0>=a?C.verses[b-1]:a>b?C.verses[0]:C.verses[a-1]}function Q(a,b){for(var c=C.verses.length,d=0;d<c;d++){var f=C.verses[d];if(f.part===a&&f.verse===b)return f}return null}
function I(a){e.map(function(a){var b=document.getElementById(a+"View");b&&(b.style.display="none");a=document.querySelectorAll("."+a+"-view");for(b=0;b<a.length;b++)a[b].style.display="none"});var b=e[a];document.getElementById(b+"View").style.display="block";b=document.querySelectorAll("."+b+"-view");for(var c=0;c<b.length;c++)b[c].style.display="block";a=a===m;t.style.display=a?"none":"block";u.style.display=a?"none":"block";L()}
function M(){var a=B.selectedPart,b=B.selectedVerse;(D=Q(a,b))?(R(),n.innerHTML=S(D,"verse",null)):n.innerHTML="Verse "+a+":"+b+" not found!"}
function N(){var a=B.selectedVerseGroup.split(":"),b=parseInt(a[0],10);a=a[1];var c=a.split("-"),d=parseInt(c[1],10),f=[];for(c=parseInt(c[0],10);c<=d;c++)f.push(S(Q(b,c),"group",null));A.innerHTML=f.join("");var g="",k="";d=C.verseGroups[b-1];f=d.groups.length;for(c=0;c<f;c++)a===d.groups[c]&&(0<c?g=b+":"+d.groups[c-1]:1===b?(g=C.verseGroups[16].groups,g="17:"+g[g.length-1]):(g=b-1,k=C.verseGroups[g-1].groups,g=g+":"+k[k.length-1]),k=c<f-1?b+":"+d.groups[c+1]:17===b?"1:"+C.verseGroups[0].groups[0]:
b+1+":"+C.verseGroups[b].groups[0]);T(g,k)}function K(){var a=B.searchStr;if(a){for(var b=0,c=[],d=C.verses.length,f=0;f<d;f++){var g=C.verses[f];(g.ro+g.en_6th_ed+g.jp1+g.jp2+g.kanji).match(new RegExp(a,"i"))&&(b++,c.push(S(g,"search",a)))}c.unshift('<p>Search "'+a+'" yields '+b+" results.</p>");z.innerHTML=c.join("")}else z.innerHTML="<p>Enter a search term.</p>"}
function U(){var a=[];C.verseGroups.map(function(b){var c=b.part;a.push('<option value="" disabled="true">- Part '+c+" -</option>");b.groups.map(function(b){b=c+":"+b;a.push('<option value="'+b+'">'+b+"</option>")})});r.innerHTML=a.join("")}function T(a,b){function c(){B.selectedVerseGroup=b;N()}function d(){B.selectedVerseGroup=a;N()}V(t,B.selectedVerseGroup,d,c);V(u,B.selectedVerseGroup,d,c)}
function R(){function a(){F(f.part);G(f.verse)}function b(){F(d.part);G(d.verse)}var c="Verse "+D.part+":"+D.verse,d=P(D.id-1),f=P(D.id+1);V(t,c,b,a);V(u,c,b,a)}function V(a,b,c,d){a.innerHTML=v.innerHTML;var f=a.getElementsByClassName("verse-nav-next-btn")[0],g=a.getElementsByClassName("verse-nav-middle")[0];a.getElementsByClassName("verse-nav-prev-btn")[0].onclick=c;f.onclick=d;g.innerHTML=b}
function S(a,b,c){c=c||!1;if(a){var d=a.part+":"+a.verse,f=W(a.ro.split(/\s{2,}/g).join("<br/>"),c),g=W(a.kanji.split(/\s{2,}/g).join("<br/>"),c),k=W(a.en_6th_ed,c);c=W(a.jp1+"<br/>"+a.jp2,c);return'<div class="verse-display">'+(B[b+"Options"].showRomanized?"<blockquote>"+f+"</blockquote>":"")+(B[b+"Options"].showJapanese?"<blockquote>"+c+"</blockquote>":"")+(B[b+"Options"].showEnglish?"<blockquote>"+k+"</blockquote>":"")+(B[b+"Options"].showKanji?"<blockquote>"+g+"</blockquote>":"")+'<table class="full-width"><tbody><tr><td>In Life of Oyasama?: '+
(a.in_life_of_oyasama?"&#9989;":"&#10060;")+"In Doctrine?: "+(a.in_doctrine?"&#9989;":"&#10060;")+"</td><td>"+d+"</td></tr></tbody></table></div>"}return"Verse not found."}function W(a,b){if(!b)return a;b=new RegExp(b,"i");var c='<span class="highlight">'+a.match(b)+"</span>";return a.replace(b,c)}
function X(){e.map(function(a){console.log("generating view options for viewName="+a);for(var b=w.cloneNode(!0),c=b.querySelectorAll("input"),d=b.querySelectorAll("label"),f={},g=0;g<c.length;f={a:f.a},g++){var k=c[g],aa=k.id.replace("-verse","-"+a);f.a=k.id.replace("-verse","").replace("show","").replace("Cbx","");k.id=aa;k.onchange=function(b){return function(){var c=b.a,d=document.getElementById("show"+c+"Cbx-"+a);if(d){var f=B[a+"Options"]["show"+c];"undefined"!==f&&(B[a+"Options"]["show"+c]=
!f,d.checked=!f)}L()}}(f);k.checked=B[a+"Options"]["show"+f.a]}for(c=0;c<d.length;c++)d[c].htmlFor=d[c].htmlFor.replace("-verse","-"+a);d=document.getElementById(a+"OptionsRow");d.innerHTML="";d.appendChild(b);document.getElementById(a+"ViewMenuItem").onclick=function(){var b=e.indexOf(a);B.view=b;I(b)}})}function O(a){var b=[];C.verses.map(function(c){c.part===parseInt(a,10)&&(c=c.verse,b.push('<option value="'+c+'">'+c+"</option>"))});q.innerHTML=b.join("")}
window.onload=function(){var a=window.localStorage.getItem("ofudesaki-browser");a&&(a=JSON.parse(a))&&(B=a,B.isDataLoaded=!0);ba();X()};window.addEventListener("beforeunload",function(){alert("beforeunload");Y()});window.addEventListener("unload",function(){alert("unload");Y()});function Y(){B.isDataLoaded&&window.localStorage.setItem("ofudesaki-browser",JSON.stringify(B))}
function ba(){ca(function(a){C=a;a=[];for(var b=1;18>=b;b++)a.push('<option value="'+b+'">'+b+"</option>");p.innerHTML=a.join("");U();E()})}function ca(a){var b=new XMLHttpRequest,c=null;b.open("GET","./ofudesaki.json",!0);b.onload=function(){200<=b.status&&400>b.status?((c=JSON.parse(b.responseText))||alert('"./ofudesaki.json" not loaded'),a(c)):alert('"./ofudesaki.json" could not be retreived.')};b.onerror=function(){alert('"./ofudesaki.json" could not be retreived.')};b.send()}
function Z(a){for(var b=a.className.split(/\s+/),c=b.length,d=0;d<c;d++)if("active"===b[d]){b.splice(d,1);break}c===b.length&&b.push("active");a.className=b.join(" ")}(function(a,b){var c=b.getElementById("layout"),d=b.getElementById("menu"),f=b.getElementById("menuLink");f.onclick=function(a){a.preventDefault();Z(c);Z(d);Z(f)}})(window,window.document);
